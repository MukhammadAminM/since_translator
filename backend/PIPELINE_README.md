# –ú–æ–¥—É–ª—å–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π –º–æ–¥—É–ª—å–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏:

```
PDF ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ‚Üí –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª ‚Üí –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Üí –ü–µ—Ä–µ–≤–æ–¥ ‚Üí –°–±–æ—Ä–∫–∞ DOCX
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥—É–ª–∏

1. **PDF Extractor** (`services/pdf_extractor.py`)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF —á–µ—Ä–µ–∑ PyMuPDF –∏–ª–∏ pdfplumber
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OCR —á–µ—Ä–µ–∑ Tesseract
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü

2. **Formula Extractor** (`services/formula_extractor.py`)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª –∏–∑ —Ç–µ–∫—Å—Ç–∞
   - –ó–∞–º–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã `<<<FORMULA_N>>>`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LaTeX, –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –∏–Ω–¥–µ–∫—Å–æ–≤

3. **Formula Recognizer** (`services/formula_recognizer.py`)
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª —á–µ—Ä–µ–∑ Mathpix API
   - Retry —Å exponential backoff
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LaTeX –∏ MathML

4. **Text Translator** (`services/text_translator.py`)
   - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —Ñ–æ—Ä–º—É–ª
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π OpenAI

5. **Document Builder** (`services/document_builder.py`)
   - –°–±–æ—Ä–∫–∞ DOCX –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ñ–æ—Ä–º—É–ª: PNG (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) –∏ OMML (–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã Word)

6. **Translation Pipeline** (`services/pipeline.py`)
   - –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install PyMuPDF pdfplumber python-docx openai requests pillow matplotlib
pip install pdf2image pytesseract  # –î–ª—è OCR
pip install lxml  # –î–ª—è OMML —Ä–µ–∂–∏–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```env
OPENAI_API_KEY=your_openai_api_key
MATHPIX_APP_ID=your_mathpix_app_id
MATHPIX_APP_KEY=your_mathpix_app_key
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from pathlib import Path
from services.pipeline import TranslationPipeline, PipelineConfig, FormulaMode

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞
pipeline = TranslationPipeline(output_dir="outputs")

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config = PipelineConfig(
    source_lang="ru",
    target_lang="en",
    model="engineering",
    formula_mode=FormulaMode.PNG,  # –∏–ª–∏ FormulaMode.OMML
    use_ocr=False,
    use_mathpix=True
)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF
result = await pipeline.process(
    pdf_path=Path("document.pdf"),
    config=config
)

if result.success:
    print(f"–§–∞–π–ª —Å–æ–∑–¥–∞–Ω: {result.output_file}")
    print(f"–ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ä–º—É–ª: {result.formulas_count}")
    print(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —Ñ–æ—Ä–º—É–ª: {result.recognized_formulas_count}")
else:
    print(f"–û—à–∏–±–∫–∞: {result.error}")
```

## üìù API Endpoints

### POST `/api/translate-file`

–ü–µ—Ä–µ–≤–æ–¥–∏—Ç PDF —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `file`: PDF —Ñ–∞–π–ª (multipart/form-data)
- `sourceLang`: –ò—Å—Ö–æ–¥–Ω—ã–π —è–∑—ã–∫ (`ru`, `ar`, `zh`)
- `model`: –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∞ (`general`, `engineering`, `academic`, `scientific`)
- `formulaMode`: –†–µ–∂–∏–º —Ñ–æ—Ä–º—É–ª (`png` –∏–ª–∏ `omml`)
- `useOCR`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OCR (boolean)
- `useMathpix`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Mathpix (boolean)

**–û—Ç–≤–µ—Ç:**
```json
{
  "downloadUrl": "/api/download/filename.docx",
  "message": "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω..."
}
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### PipelineConfig

```python
@dataclass
class PipelineConfig:
    source_lang: Literal["ru", "ar", "zh"]  # –ò—Å—Ö–æ–¥–Ω—ã–π —è–∑—ã–∫
    target_lang: str = "en"  # –¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫
    model: Literal["general", "engineering", "academic", "scientific"] = "general"
    formula_mode: FormulaMode = FormulaMode.PNG  # PNG –∏–ª–∏ OMML
    use_ocr: bool = False  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OCR
    ocr_lang: Optional[str] = None  # –Ø–∑—ã–∫ OCR (–Ω–∞–ø—Ä–∏–º–µ—Ä, "rus+eng")
    use_mathpix: bool = True  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Mathpix
    include_mathml: bool = True  # –í–∫–ª—é—á–∞—Ç—å MathML –≤ –æ—Ç–≤–µ—Ç Mathpix
```

## üéØ –†–µ–∂–∏–º—ã —Ñ–æ—Ä–º—É–ª

### PNG —Ä–µ–∂–∏–º (–±—ã—Å—Ç—Ä—ã–π)

–§–æ—Ä–º—É–ª—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ matplotlib.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
- –•–æ—Ä–æ—à–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ Word

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –§–æ—Ä–º—É–ª—ã –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã
- –ë–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞

### OMML —Ä–µ–∂–∏–º (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)

–§–æ—Ä–º—É–ª—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã Word (OMML).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –§–æ—Ä–º—É–ª—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã –≤ Word
- –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
- –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é LaTeX ‚Üí MathML ‚Üí OMML
- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** OMML —Ä–µ–∂–∏–º —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ MathML ‚Üí OMML.

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–∞–π–ø–ª–∞–π–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–æ–¥—É–ª—å `logging`:

```python
import logging

logging.basicConfig(level=logging.INFO)
```

–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
- `INFO`: –û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `DEBUG`: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `WARNING`: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `ERROR`: –û—à–∏–±–∫–∏

## üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ PDF**: Fallback –Ω–∞ OCR, –µ—Å–ª–∏ –æ–±—ã—á–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª**: Retry —Å exponential backoff
3. **–ü–µ—Ä–µ–≤–æ–¥**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
4. **–°–±–æ—Ä–∫–∞ DOCX**: Fallback –Ω–∞ PNG, –µ—Å–ª–∏ OMML –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞:

```python
import pytest
from services.pipeline import TranslationPipeline, PipelineConfig, FormulaMode

@pytest.mark.asyncio
async def test_pipeline():
    pipeline = TranslationPipeline()
    config = PipelineConfig(
        source_lang="ru",
        model="general",
        formula_mode=FormulaMode.PNG
    )
    result = await pipeline.process(Path("test.pdf"), config)
    assert result.success
    assert result.output_file.exists()
```

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ pdf_extractor.py      # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ PDF
‚îÇ   ‚îú‚îÄ‚îÄ formula_extractor.py   # –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª
‚îÇ   ‚îú‚îÄ‚îÄ formula_recognizer.py  # –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Mathpix
‚îÇ   ‚îú‚îÄ‚îÄ text_translator.py     # –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ document_builder.py    # –°–±–æ—Ä–∫–∞ DOCX
‚îÇ   ‚îî‚îÄ‚îÄ pipeline.py            # –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ main_new.py                # FastAPI —Å –Ω–æ–≤—ã–º –ø–∞–π–ø–ª–∞–π–Ω–æ–º
‚îî‚îÄ‚îÄ PIPELINE_README.md          # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞

–°—Ç–∞—Ä—ã–π –∫–æ–¥ (`services/translator.py`) –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞:

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `main_new.py` –≤–º–µ—Å—Ç–æ `main.py`
2. –ò–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ `TranslationPipeline` –Ω–∞–ø—Ä—è–º—É—é

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **OMML —Ä–µ–∂–∏–º**: –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ MathML ‚Üí OMML
2. **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª**: –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü —Ü–µ–ª–∏–∫–æ–º (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
3. **–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å OCR**: –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —è–∑—ã–∫–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ Tesseract

## üöß –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

- [ ] –£–ª—É—á—à–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Ñ–æ—Ä–º—É–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- [ ] –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è OMML –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (DOCX, TXT)
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª
- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—É–ª

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –õ–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

